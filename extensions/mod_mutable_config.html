<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
	    <meta charset="utf-8"/>
	    <title>Apache Tamaya&amp;#8201;&amp;#8212;&amp;#8201;Extension: Mutable Configuration</title>
	    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
	    <meta name="description" content=""/>
	    <meta name="author" content=""/>
	    <meta name="keywords" content=""/>
	    <meta name="generator" content="'JBake '+'${version}"/>

	    <!-- Le styles -->
	    <link href="../css/bootstrap.min.css" rel="stylesheet"/>
	    <link href="../css/asciidoctor.css" rel="stylesheet"/>
	    <link href="../css/base.css" rel="stylesheet"/>
	    <link href="../css/prettify.css" rel="stylesheet"/>

	    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
	    <!--[if lt IE 9]>
	      <script src="../js/html5shiv.min.js"></script>
	    <![endif]-->

	    <!-- Fav and touch icons from ASF -->
			<link rel="shortcut icon" href="../favicon.ico"/>
			<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png"/>
		  <link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png"/>
		  <link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png"/>
		  <link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png"/>
		  <link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png"/>
		  <link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png"/>
		  <link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png"/>
		  <link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png"/>
		  <link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png"/>
		  <link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32"/>
		  <link rel="icon" type="image/png" href="../favicons/favicon-194x194.png" sizes="194x194"/>
		  <link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96"/>
		  <link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192"/>
		  <link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16"/>
		  <link rel="manifest" href="../favicons/manifest.json"/>
		  <link rel="shortcut icon" href="../favicons/favicon.ico"/>
		  <meta name="msapplication-TileColor" content="#603cba"/>
		  <meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png"/>
		  <meta name="msapplication-config" content="../favicons/browserconfig.xml"/>
		  <meta name="theme-color" content="#303284"/>
	</head>
	<body onload="prettyPrint()">
	<div id="wrap">
		<div>

	  <!-- Fixed navbar -->
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../">Apache Tamaya (incubating)</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
						<li><a href="../index.html">Home</a></li>
						<li><a href="../quickstart.html">Quickstart</a></li>
						<li><a href="../index.html">Documentation</a></li>
						<li><a href="..//apidocs/index.html">API</a></li>
						<li><a href="../index.html">Development</a></li>
						<li><a href="../index.html">Releases</a></li>
						<li><a href="../about.html">About</a></li>
						<li><a href="../sitemap.xml">Sitemap</a></li>
            <li><a href="../feed.xml">Subscribe</a></li>
<!--
						<li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">Dropdown <b class="caret"></b></a>
              <ul class="dropdown-menu">
                <li><a href="#">Action</a></li>
                <li><a href="#">Another action</a></li>
                <li><a href="#">Something else here</a></li>
                <li class="divider"></li>
                <li class="dropdown-header">Nav header</li>
                <li><a href="#">Separated link</a></li>
                <li><a href="#">One more separated link</a></li>
              </ul>
            </li>
-->
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>

	</div>
		<div class="container">

			<div class="page-header">
				<h1>Apache Tamaya&amp;#8201;&amp;#8212;&amp;#8201;Extension: Mutable Configuration</h1>
			</div>

			<p><em>2016-11-02</em></p>

			<p><div id="preamble">
<div class="sectionbody">
<!-- toc disabled -->
</div>
</div>
<div class="sect1">
<h2 id="Core">Tamaya Mutable Configuration (Extension Module)</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_overview">Overview</h3>
<div class="paragraph">
<p>Tamaya Configuration by default is read-only, which covers must of the use cases. But there are many legit scenarios
where configuration should be written back to some backend systems or the local file system. This module adds this
functionality.</p>
</div>
</div>
<div class="sect2">
<h3 id="_compatibility">Compatibility</h3>
<div class="paragraph">
<p>The module is based on Java 7, so it can be used with Java 7 and beyond.</p>
</div>
</div>
<div class="sect2">
<h3 id="_installation">Installation</h3>
<div class="paragraph">
<p>To benefit from configuration mutability support you only must add the corresponding dependency to your module:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.apache.tamaya.ext&lt;/groupId&gt;
  &lt;artifactId&gt;tamaya-mutable-config&lt;/artifactId&gt;
  &lt;version&gt;{tamayaVersion}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_core_architecture">Core Architecture</h3>
<div class="paragraph">
<p>The core of the module is the MutableConfigurationProvider singleton, which provides access to MutableConfiguration
instance, which extends Configuration. This interface adds additional methods to add/update or remove property values.
Hereby changes applied are managed in a transaction like context, called ConfigChangeContext. Each context defines
a UUID that identifes a change.
Backends for writing changes applied are of type MutablePropertySource, similarly extending the PropertySource
SPI with methods for writing changes back. Registrations and ordering policies are like with ordinary property sources,
with one important difference. Mutable property source can be targeted by write operations.</p>
</div>
<div class="paragraph">
<p>Summarizing a MutableConfiguration can be obtained as follows:</p>
</div>
<div class="listingblock">
<div class="title">Accessing and changing a configuration</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">MutableConfiguration config = MutableConfigurationProvider.createMutableConfiguration();
config.set("newKey", "newValue")
      .set("anotherKey", "updatedValue")
      .remove("valueNotValid")
      .commit();</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above scenario we use the overall system&#8217;s configuration as the backend to be used.
We can also pass any Configuration to render it into a mutable instance, e.g.</p>
</div>
<div class="listingblock">
<div class="title">Explicitly passing the backing configuration</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">Configuration config = ...;
MutableConfiguration config =
    MutableConfigurationProvider.createMutableConfiguration(config);</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If a configuration does not contain any MutablePropertySource instances, a MutableConfiguration built
      from it will not be able to accept any changes.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Following is the complete listing of the MutableConfigurationProvider accessor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public final class MutableConfigurationProvider {

    private MutableConfigurationProvider(){}

    public static MutableConfiguration getMutableConfiguration();
    public static MutableConfiguration getMutableConfiguration(Configuration configuration);

    [...]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Hereby MutableConfiguration is defined as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public interface MutableConfiguration extends Configuration {

    UUID startTransaction();
    void commitTransaction();
    void rollbackTransaction();
    UUID getTransactionId();
    boolean getAutoCommit();
    void setAutoCommit(boolean autoCommit);

    void setChangePropagationPolicy(ChangePropagationPolicy changePropagationPolicy);
    ChangePropagationPolicy getChangePropagationPolicy();

    boolean isWritable(String keyExpression);
    boolean isRemovable(String keyExpression);
    boolean isExisting(String keyExpression);
    List&lt;MutablePropertySource&gt; getMutablePropertySources();
    List&lt;MutablePropertySource&gt; getPropertySourcesThatCanWrite(String keyExpression);
    List&lt;MutablePropertySource&gt; getPropertySourcesThatCanRemove(String keyExpression);
    List&lt;MutablePropertySource&gt; getPropertySourcesThatKnow(String keyExpression);

    MutableConfiguration put(String key, String value);
    MutableConfiguration putAll(Map&lt;String, String&gt; properties);
    MutableConfiguration remove(Collection&lt;String&gt; keys);
    MutableConfiguration remove(String... keys);

}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_targeting_the_right_mutablepropertysources">Targeting the right MutablePropertySources</h4>
<div class="paragraph">
<p>A Configuration may have multiple MutablePropertySource present. These are members of Tamaya&#8217;s oredered list of
PropertySources to evaluate the configuration. Nevertheless writing back changes requires additional aspects to
be considered:
* Should changes being written back to all mutable property sources? Or should a key that could be added or removed
  on a more significant instance not be written/removed on less significant property source instances?
* Should a change be applied only to a specific mutable property source, regardless its position in the
  processing chain?</p>
</div>
<div class="paragraph">
<p>Therefore a ChangePropagationPolicy can be set on a MutableConfiguration instance, which allows to control
this aspect:</p>
</div>
<div class="listingblock">
<div class="title">Explicitly passing the backing configuration</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public interface ChangePropagationPolicy {
    void applyChanges(Collection&lt;PropertySource&gt; propertySources, UUID transactionID, Map&lt;String,String&gt; changes);
    void applyChange(Collection&lt;PropertySource&gt; propertySources, UUID transactionID, String key, String value);
    void applyRemove(Collection&lt;PropertySource&gt; propertySources, UUID transactionID, String... keys);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, changes are applied to all registered MutablePropertySources similarly.</p>
</div>
<div class="paragraph">
<p>Also the MutableConfigurationProvider provides access to the most commonly used change propagation policies:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public final class MutableConfigurationProvider {

    private MutableConfigurationProvider(){}

    public static MutableConfiguration getMutableConfiguration();
    public static MutableConfiguration getMutableConfiguration(Configuration configuration);

    public static ChangePropagationPolicy getApplyAllChangePolicy();
    public static ChangePropagationPolicy getApplyMostSignificantOnlyChangePolicy();
    public static ChangePropagationPolicy getApplySelectiveChangePolicy(String... propertySourceNames);
    public static ChangePropagationPolicy getApplyNonePolicy();
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_some_aspects_to_consider">Some Aspects to consider</h4>
<div class="paragraph">
<p>Due to Tamaya&#8217;s design the effective effect of your changes to the overall configuration, cannot
be easily predicted, since it depends on several aspects:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>is the corresponding configuration resource configured as part of the current system&#8217;s configuration?</p>
</li>
<li>
<p>what is the PropertySource's ordinal? Is it overriding or overridden by other sources?</p>
</li>
<li>
<p>is the change directly visible to the configuration system? E.g. injected values are normally not updated,
whereas injecting a DynamicValue&lt;T&gt; instance allows to detect and react single value changes. Also the
PropertySources implementation must be able to detect any configuration changes and adapt its values returned
accordingly.</p>
</li>
<li>
<p>Is configuration cached, or written/collected directly on access?</p>
</li>
<li>
<p>can the changes applied be committed at all?</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>So it is part of your application configuration design to clearly define, which property sources may be read-only, which
may be mutable, how overriding should work and to which backends finally any changes should be written back. To
support such fine granular scenarios a MutableConfiguration also offers methods to determine if a key
is writable at all or can be removed or updated:</p>
</div>
<div class="listingblock">
<div class="title">Checking for mutability</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">MutableConfiguration config = MutableConfigurationProvider.createMutableConfiguration();

if(config,isWritable("mycluster.shared.appKey")){
    config.set("newKey", "newValue");
}
if(config,isRemovable("mycluster.myapp.myKey")){
    config.remove("mycluster.myapp.myKey");
}
config.commit();</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_changes">Configuration Changes</h3>
<div class="paragraph">
<p>This module does not handle detection of changes to the overall system&#8217;s Configuration. This can be done in
several ways, e.g. by:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>using the <em>tamaya-events</em> extension, which can be used to observe the system&#8217;s configuration and
publishing events when things have been changed.</p>
</li>
<li>
<p>The SPI implementing the MutableConfigurationBackendSpi may inform/update any affected PropertySource,
PropertySourceProvider instances about the changes applied.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_supported_backends">Supported Backends</h3>
<div class="paragraph">
<p>Multiple backends are supported. E.g. the <em>etcd</em> integration module of Tamaya also registers
corresponding SPI implementations/backends. By default this module comes with
the following MutablePropertySource implementations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>MutablePropertySource resources, targeting local .properties files, following the java.util.Properties
format.</p>
</li>
<li>
<p>MutableXmlPropertySource resources, targeting local .xml property files, following the java.util.Properties
XML format.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_spis">SPIs</h3>
<div class="paragraph">
<p>The module defines MutableConfigurationProviderSpi, that is used as a delegate by the MutableConfigurationProvider
singleton accessor:</p>
</div>
<div class="listingblock">
<div class="title">SPI: MutableConfigurationProviderSpi</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public interface MutableConfigurationProviderSpi {
   MutableConfiguration createMutableConfiguration(Configuration configuration);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Implementations are registered with the current ServiceContext, by default as a
 java.util.ServiceLoader service.</p>
</div>
<div class="paragraph">
<p>As convenience the following base classes are provided:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>org.apache.tamaya.mutableconfig.propertysource.AbstractMutablePropertySource simplifying implementation of
MutablePropertySource.</p>
</li>
</ul>
</div>
</div>
</div>
</div></p>

			<hr />
		</div>
	</div>
	<div>
			<div id="push"></div>

		    <div id="footer">
		      <div class="container">
		        <p class="muted credit">&copy; 2014-2016 Apache Software Foundation | Mixed with <a href="http://getbootstrap.com/">Bootstrap v3.1.1</a>
							| Baked with <a href="http://jbake.org">JBake <span>v2.5.0</span></a>
							at <span>2016-11-02</span>
						</p>
						<p>
								<b>Disclaimer</b>
                    Apache Tamaya (incubating) is an effort undergoing
                    incubation at
                    The Apache Software Foundation (ASF), sponsored by
                    the name of Apache Incubator. Incubation is required of
                    all newly accepted projects until a further review indicates
                    that the infrastructure, communications, and decision making
                    process have stabilized in a manner consistent with other
                    successful ASF projects. While incubation status is not
                    necessarily a reflection of the completeness or stability of
                    the code, it does indicate that the project has yet to
                    be fully endorsed by the ASF.<br />
                    <a href="http://incubator.apache.org/guides/website.html" style="border:0px;" target="_target"><img class="incubator-logo" src="../logos/egg-logo2.png"/></a>
							</p>
		      </div>
		    </div>

		    <!-- Le javascript
		    ================================================== -->
		    <!-- Placed at the end of the document so the pages load faster -->
		    <script src="../js/jquery-1.11.1.min.js"></script>
		    <script src="../js/bootstrap.min.js"></script>
		    <script src="../js/prettify.js"></script>

    	</div>
    </body>
</html>
